@model ClaimModel
@{
    ViewData["Title"] = "Review Claim - Academic Manager";
}

<div class="container">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="Dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="PendingClaims">Pending Claims</a></li>
                    <li class="breadcrumb-item active">Review Claim</li>
                </ol>
            </nav>

            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>Review Claim Submission
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Claim Summary -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h5>Claim Details</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Lecturer:</strong> @Model.Lecturer?.FirstName @Model.Lecturer?.LastName<br>
                                    <strong>Employee ID:</strong> @Model.Lecturer?.EmployeeId<br>
                                    <strong>Department:</strong> <span class="badge bg-info">@Model.Lecturer?.Department</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Claim Month:</strong> @Model.Month.ToString("MMMM yyyy")<br>
                                    <strong>Submitted:</strong> @Model.SubmissionDate.ToString("MMM dd, yyyy 'at' hh:mm tt")<br>
                                    <strong>Status:</strong> <span class="badge @Model.StatusBadgeClass">@Model.Status</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Financial Summary</h6>
                                    <h3 class="text-success">R @Model.TotalAmount.ToString("N2")</h3>
                                    <p class="mb-0">
                                        @Model.HoursWorked hours × R @Model.HourlyRate.ToString("N2")
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Claim Breakdown -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Work Details</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Hours Worked</th>
                                            <th>Hourly Rate</th>
                                            <th>Total Amount</th>
                                            <th>Additional Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>@Model.HoursWorked hours</td>
                                            <td>R @Model.HourlyRate.ToString("N2")</td>
                                            <td><strong>R @Model.TotalAmount.ToString("N2")</strong></td>
                                            <td>@(string.IsNullOrEmpty(Model.AdditionalNotes) ? "No additional notes" : Model.AdditionalNotes)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Supporting Documents -->
                    @if (Model.SupportingDocuments?.Any() == true)
                    {
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>Supporting Documents</h5>
                                <div class="list-group">
                                    @foreach (var doc in Model.SupportingDocuments)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file @(doc.ContentType.Contains("pdf") ? "text-danger" : "text-primary") me-2"></i>
                                                @doc.OriginalFileName
                                                <small class="text-muted ms-2">(@doc.FileSize bytes)</small>
                                            </div>
                                            <a href="@Url.Action("DownloadDocument", "Claims", new { id = doc.Id })"
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i>Download
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Action Form -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">Academic Review Action</h5>
                                </div>
                                <div class="card-body">
                                    <form asp-action="ProcessClaimReview" method="post">
                                        <input type="hidden" name="claimId" value="@Model.Id" />

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="action" class="form-label">Select Action</label>
                                                    <select class="form-select" id="action" name="action" required>
                                                        <option value="">-- Select Action --</option>
                                                        <option value="Approve">Approve Claim</option>
                                                        <option value="RequestInfo">Request More Information</option>
                                                        <option value="Reject">Reject Claim</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="priority" class="form-label">Priority Level</label>
                                                    <select class="form-select" id="priority" name="priority">
                                                        <option value="Normal">Normal</option>
                                                        <option value="High">High Priority</option>
                                                        <option value="Urgent">Urgent</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="reviewNotes" class="form-label">Review Notes</label>
                                            <textarea class="form-control" id="reviewNotes" name="reviewNotes"
                                                      rows="4" placeholder="Enter your review comments, feedback, or additional requirements..."
                                                      required></textarea>
                                            <div class="form-text">
                                                These notes will be visible to the lecturer and HR department.
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between">
                                            <a href="@Url.Action("PendingClaims")" class="btn btn-outline-secondary">
                                                <i class="fas fa-arrow-left me-1"></i>Back to List
                                            </a>
                                            <div>
                                                <button type="submit" name="action" value="RequestInfo" class="btn btn-warning me-2">
                                                    <i class="fas fa-question-circle me-1"></i>Request Info
                                                </button>
                                                <button type="submit" name="action" value="Reject" class="btn btn-danger me-2">
                                                    <i class="fas fa-times-circle me-1"></i>Reject
                                                </button>
                                                <button type="submit" name="action" value="Approve" class="btn btn-success">
                                                    <i class="fas fa-check-circle me-1"></i>Approve
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status History -->
                    @if (Model.StatusHistory?.Any() == true)
                    {
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5>Status History</h5>
                                <div class="timeline">
                                    @foreach (var history in Model.StatusHistory.OrderBy(h => h.ChangedDate))
                                    {
                                        <div class="timeline-item">
                                            <div class="timeline-marker bg-@(history.NewStatus == ClaimStatus.Approved ? "success" : history.NewStatus == ClaimStatus.Rejected ? "danger" : "warning")"></div>
                                            <div class="timeline-content">
                                                <h6>@history.NewStatus</h6>
                                                <p class="mb-1">@history.ChangeNotes</p>
                                                <small class="text-muted">
                                                    By @history.ChangedBy on @history.ChangedDate.ToString("MMM dd, yyyy 'at' hh:mm tt")
                                                </small>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-marker {
            position: absolute;
            left: -30px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 3px solid #fff;
        }

        .timeline-content {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }

        .avatar-sm {
            width: 40px;
            height: 40px;
            font-size: 14px;
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Update button states based on selected action
            $('#action').change(function() {
                var action = $(this).val();
                $('button[type="submit"]').prop('disabled', true);
                $('button[value="' + action + '"]').prop('disabled', false);
            });

            // Form validation
            $('form').submit(function(e) {
                var action = $('#action').val();
                var notes = $('#reviewNotes').val().trim();

                if (!action) {
                    e.preventDefault();
                    alert('Please select an action.');
                    return false;
                }

                if (!notes) {
                    e.preventDefault();
                    alert('Please provide review notes.');
                    return false;
                }

                // Confirm rejection
                if (action === 'Reject') {
                    if (!confirm('Are you sure you want to reject this claim? This action cannot be undone.')) {
                        e.preventDefault();
                        return false;
                    }
                }
            });
        });
    </script>
}